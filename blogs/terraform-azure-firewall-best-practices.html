<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terraform Best Practices for Azure Firewall Management | Mustafa Zeya</title>
    <link rel="icon" type="image/svg+xml" href="/assets/favicon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    
    <style>
        /* Theme Variables */
        :root {
            /* Dark Theme (Default) */
            --primary-bg: #0a0e27;
            --secondary-bg: #1a1f3a;
            --accent-blue: #00d9ff;
            --accent-purple: #8b5cf6;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --text-primary: #ffffff;
            --text-secondary: #a1a1aa;
            --card-bg: rgba(26, 31, 58, 0.8);
            --border-color: rgba(255, 255, 255, 0.1);
            --gradient-1: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
        }

        /* Light Theme */
        [data-theme="light"] {
            --primary-bg: #f8fafc;
            --secondary-bg: #ffffff;
            --accent-blue: #0ea5e9;
            --accent-purple: #7c3aed;
            --accent-green: #059669;
            --accent-red: #dc2626;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --card-bg: rgba(255, 255, 255, 0.9);
            --border-color: rgba(0, 0, 0, 0.1);
            --gradient-1: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
        }

        /* Azure Theme */
        [data-theme="azure"] {
            --primary-bg: #0f172a;
            --secondary-bg: #1e293b;
            --accent-blue: #0078d4;
            --accent-purple: #5c2d91;
            --accent-green: #107c10;
            --accent-red: #d13438;
            --text-primary: #ffffff;
            --text-secondary: #94a3b8;
            --card-bg: rgba(30, 41, 59, 0.8);
            --border-color: rgba(0, 120, 212, 0.2);
            --gradient-1: linear-gradient(135deg, #0078d4, #5c2d91);
        }

        /* Sunset Theme */
        [data-theme="sunset"] {
            --primary-bg: #1a0b0e;
            --secondary-bg: #2d1b1e;
            --accent-blue: #ff6b9d;
            --accent-purple: #a855f7;
            --accent-green: #fbbf24;
            --accent-red: #ef4444;
            --text-primary: #fff1f2;
            --text-secondary: #fecaca;
            --card-bg: rgba(45, 27, 30, 0.8);
            --border-color: rgba(255, 107, 157, 0.2);
            --gradient-1: linear-gradient(135deg, #ff6b9d, #a855f7);
        }

        /* Monochrome Theme */
        [data-theme="monochrome"] {
            --primary-bg: #000000;
            --secondary-bg: #1a1a1a;
            --accent-blue: #ffffff;
            --accent-purple: #d4d4d8;
            --accent-green: #a1a1aa;
            --accent-red: #52525b;
            --text-primary: #ffffff;
            --text-secondary: #a1a1aa;
            --card-bg: rgba(26, 26, 26, 0.8);
            --border-color: rgba(255, 255, 255, 0.1);
            --gradient-1: linear-gradient(135deg, #ffffff, #d4d4d8);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--primary-bg);
            color: var(--text-primary);
            line-height: 1.7;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Navigation */
        .nav-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 3rem;
        }

        .back-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            transform: translateY(-2px);
            border-color: var(--accent-blue);
        }

        /* Article Header */
        .article-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .article-meta {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .article-category {
            background: rgba(0, 217, 255, 0.1);
            color: var(--accent-blue);
            padding: 0.3rem 0.8rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .article-title {
            font-size: 2.5rem;
            font-weight: 700;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
            line-height: 1.2;
        }

        .article-excerpt {
            font-size: 1.1rem;
            color: var(--text-secondary);
            max-width: 600px;
            margin: 0 auto;
        }

        .article-tags {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1.5rem;
        }

        .article-tag {
            background: rgba(139, 92, 246, 0.1);
            color: var(--accent-purple);
            padding: 0.3rem 0.6rem;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        /* Article Content */
        .article-content {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 3rem;
            backdrop-filter: blur(20px);
        }

        .article-content h2 {
            font-size: 1.8rem;
            font-weight: 600;
            margin: 2rem 0 1rem 0;
            color: var(--text-primary);
        }

        .article-content h3 {
            font-size: 1.4rem;
            font-weight: 600;
            margin: 1.5rem 0 0.8rem 0;
            color: var(--accent-blue);
        }

        .article-content p {
            margin-bottom: 1.5rem;
            color: var(--text-secondary);
        }

        .article-content ul, .article-content ol {
            margin: 1rem 0 1.5rem 2rem;
            color: var(--text-secondary);
        }

        .article-content li {
            margin-bottom: 0.5rem;
        }

        .article-content blockquote {
            border-left: 4px solid var(--accent-blue);
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
            background: rgba(0, 217, 255, 0.05);
            border-radius: 0 8px 8px 0;
            font-style: italic;
            color: var(--text-secondary);
        }

        .code-block {
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            overflow-x: auto;
        }

        .code-block pre {
            margin: 0;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .code-block code {
            color: var(--text-primary);
        }

        .inline-code {
            background: rgba(0, 217, 255, 0.1);
            color: var(--accent-blue);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9em;
        }

        .warning-box {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 8px;
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
        }

        .warning-box h4 {
            color: var(--accent-red);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .info-box {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 8px;
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
        }

        .info-box h4 {
            color: var(--accent-green);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Navigation within article */
        .article-nav {
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--accent-blue);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .nav-link:hover {
            gap: 0.8rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .article-content {
                padding: 2rem 1.5rem;
            }

            .article-title {
                font-size: 2rem;
            }

            .article-meta {
                flex-direction: column;
                gap: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <nav class="nav-bar">
            <a href="/blogs" class="back-btn">
                <i class="fas fa-arrow-left"></i>
                <span>Back to Blog</span>
            </a>
            <a href="/" class="back-btn">
                <i class="fas fa-home"></i>
                <span>Portfolio</span>
            </a>
        </nav>

        <header class="article-header">
            <div class="article-meta">
                <div class="article-category">Infrastructure</div>
                <div>
                    <i class="fas fa-calendar"></i>
                    March 15, 2025
                </div>
                <div>
                    <i class="fas fa-clock"></i>
                    8 min read
                </div>
            </div>
            <h1 class="article-title">Terraform Best Practices for Azure Firewall Management</h1>
            <p class="article-excerpt">
                Learn how to effectively manage Azure Firewall resources using Terraform, including network rules, 
                application rules, and security policies. Discover patterns for scaling firewall configurations 
                across multiple environments.
            </p>
            <div class="article-tags">
                <span class="article-tag">Terraform</span>
                <span class="article-tag">Azure</span>
                <span class="article-tag">Security</span>
                <span class="article-tag">Networking</span>
            </div>
        </header>

        <article class="article-content">
            <p>Azure Firewall is a critical component of any cloud security strategy, providing network-level protection for your Azure virtual networks. When managing Azure Firewall at scale, Infrastructure as Code (IaC) becomes essential. Terraform, with its declarative approach and robust Azure provider, offers an excellent solution for managing firewall configurations consistently across environments.</p>

            <h2>Understanding Azure Firewall Architecture</h2>
            <p>Before diving into Terraform configurations, it's crucial to understand the Azure Firewall components:</p>

            <ul>
                <li><strong>Azure Firewall Resource:</strong> The main firewall instance</li>
                <li><strong>Firewall Policy:</strong> Centralized rule management (recommended approach)</li>
                <li><strong>Rule Collections:</strong> Groups of related rules (Network, Application, NAT)</li>
                <li><strong>Public IP:</strong> Required for outbound connectivity</li>
                <li><strong>Subnet:</strong> Dedicated AzureFirewallSubnet with /26 minimum</li>
            </ul>

            <h2>Basic Terraform Configuration</h2>
            <p>Let's start with a basic Azure Firewall setup using Terraform. This example demonstrates the minimum required resources:</p>

            <div class="code-block">
                <pre><code class="language-hcl"># Resource Group
resource "azurerm_resource_group" "firewall" {
  name     = "rg-firewall-${var.environment}"
  location = var.location
}

# Virtual Network
resource "azurerm_virtual_network" "main" {
  name                = "vnet-${var.environment}"
  address_space       = ["10.0.0.0/16"]
  location            = azurerm_resource_group.firewall.location
  resource_group_name = azurerm_resource_group.firewall.name
}

# Azure Firewall Subnet (must be named exactly "AzureFirewallSubnet")
resource "azurerm_subnet" "firewall" {
  name                 = "AzureFirewallSubnet"
  resource_group_name  = azurerm_resource_group.firewall.name
  virtual_network_name = azurerm_virtual_network.main.name
  address_prefixes     = ["10.0.1.0/26"]
}

# Public IP for Azure Firewall
resource "azurerm_public_ip" "firewall" {
  name                = "pip-firewall-${var.environment}"
  location            = azurerm_resource_group.firewall.location
  resource_group_name = azurerm_resource_group.firewall.name
  allocation_method   = "Static"
  sku                 = "Standard"
}

# Azure Firewall
resource "azurerm_firewall" "main" {
  name                = "fw-${var.environment}"
  location            = azurerm_resource_group.firewall.location
  resource_group_name = azurerm_resource_group.firewall.name
  sku_name            = "AZFW_VNet"
  sku_tier            = "Standard"

  ip_configuration {
    name                 = "configuration"
    subnet_id            = azurerm_subnet.firewall.id
    public_ip_address_id = azurerm_public_ip.firewall.id
  }
}</code></pre>
            </div>

            <h2>Using Firewall Policies (Recommended Approach)</h2>
            <p>Azure Firewall Policy provides a centralized way to manage rules and settings. This approach is recommended for new deployments as it offers better scalability and management capabilities:</p>

            <div class="code-block">
                <pre><code class="language-hcl"># Firewall Policy
resource "azurerm_firewall_policy" "main" {
  name                = "fwpol-${var.environment}"
  resource_group_name = azurerm_resource_group.firewall.name
  location            = azurerm_resource_group.firewall.location

  dns {
    proxy_enabled = true
    servers       = var.custom_dns_servers
  }

  threat_intelligence_mode = "Alert"
}

# Network Rule Collection Group
resource "azurerm_firewall_policy_rule_collection_group" "network" {
  name               = "DefaultNetworkRuleCollectionGroup"
  firewall_policy_id = azurerm_firewall_policy.main.id
  priority           = 200

  network_rule_collection {
    name     = "AllowInternetOutbound"
    priority = 100
    action   = "Allow"

    rule {
      name                  = "AllowHTTPS"
      protocols             = ["TCP"]
      source_addresses      = ["10.0.0.0/8"]
      destination_addresses = ["*"]
      destination_ports     = ["443"]
    }

    rule {
      name                  = "AllowHTTP"
      protocols             = ["TCP"]
      source_addresses      = ["10.0.0.0/8"]
      destination_addresses = ["*"]
      destination_ports     = ["80"]
    }
  }
}

# Application Rule Collection Group
resource "azurerm_firewall_policy_rule_collection_group" "application" {
  name               = "DefaultApplicationRuleCollectionGroup"
  firewall_policy_id = azurerm_firewall_policy.main.id
  priority           = 300

  application_rule_collection {
    name     = "AllowMicrosoftServices"
    priority = 100
    action   = "Allow"

    rule {
      name = "AllowWindowsUpdate"

      protocols {
        type = "Http"
        port = 80
      }

      protocols {
        type = "Https"
        port = 443
      }

      source_addresses  = ["10.0.0.0/8"]
      destination_fqdns = [
        "*.update.microsoft.com",
        "*.windowsupdate.com",
        "update.microsoft.com",
        "windowsupdate.microsoft.com"
      ]
    }
  }
}

# Attach policy to firewall
resource "azurerm_firewall" "main" {
  name                = "fw-${var.environment}"
  location            = azurerm_resource_group.firewall.location
  resource_group_name = azurerm_resource_group.firewall.name
  sku_name            = "AZFW_VNet"
  sku_tier            = "Standard"
  firewall_policy_id  = azurerm_firewall_policy.main.id

  ip_configuration {
    name                 = "configuration"
    subnet_id            = azurerm_subnet.firewall.id
    public_ip_address_id = azurerm_public_ip.firewall.id
  }
}</code></pre>
            </div>

            <h3>Advanced Configuration Patterns</h3>
            <p>For production environments, consider these advanced patterns:</p>

            <div class="info-box">
                <h4><i class="fas fa-lightbulb"></i> Pro Tip</h4>
                <p>Use separate Terraform modules for different rule types to maintain better organization and enable team-specific ownership of firewall rules.</p>
            </div>

            <h3>1. Modular Rule Management</h3>
            <p>Organize your firewall rules into separate modules:</p>

            <div class="code-block">
                <pre><code class="language-hcl"># modules/firewall-rules/variables.tf
variable "firewall_policy_id" {
  description = "The ID of the firewall policy"
  type        = string
}

variable "rule_collections" {
  description = "Map of rule collections"
  type = map(object({
    priority = number
    rules = list(object({
      name                  = string
      protocols             = list(string)
      source_addresses      = list(string)
      destination_addresses = list(string)
      destination_ports     = list(string)
    }))
  }))
}

# modules/firewall-rules/main.tf
resource "azurerm_firewall_policy_rule_collection_group" "this" {
  for_each = var.rule_collections

  name               = each.key
  firewall_policy_id = var.firewall_policy_id
  priority           = each.value.priority

  dynamic "network_rule_collection" {
    for_each = each.value.rules
    content {
      name     = network_rule_collection.value.name
      priority = 100
      action   = "Allow"

      dynamic "rule" {
        for_each = network_rule_collection.value.rules
        content {
          name                  = rule.value.name
          protocols             = rule.value.protocols
          source_addresses      = rule.value.source_addresses
          destination_addresses = rule.value.destination_addresses
          destination_ports     = rule.value.destination_ports
        }
      }
    }
  }
}</code></pre>
            </div>

            <h3>2. Environment-Specific Configurations</h3>
            <p>Use Terraform workspaces or separate variable files for different environments:</p>

            <div class="code-block">
                <pre><code class="language-hcl"># environments/prod.tfvars
environment = "prod"
firewall_sku_tier = "Premium"
threat_intelligence_mode = "Deny"

firewall_rules = {
  "ProductionNetworkRules" = {
    priority = 200
    rules = [
      {
        name                  = "AllowHTTPS"
        protocols             = ["TCP"]
        source_addresses      = ["10.0.0.0/8"]
        destination_addresses = ["*"]
        destination_ports     = ["443"]
      }
    ]
  }
}

# environments/dev.tfvars
environment = "dev"
firewall_sku_tier = "Standard"
threat_intelligence_mode = "Alert"

firewall_rules = {
  "DevelopmentNetworkRules" = {
    priority = 200
    rules = [
      {
        name                  = "AllowAll"
        protocols             = ["Any"]
        source_addresses      = ["10.0.0.0/8"]
        destination_addresses = ["*"]
        destination_ports     = ["*"]
      }
    ]
  }
}</code></pre>
            </div>

            <h2>Security Best Practices</h2>

            <div class="warning-box">
                <h4><i class="fas fa-exclamation-triangle"></i> Security Warning</h4>
                <p>Never use overly permissive rules like "Allow All" in production environments. Always follow the principle of least privilege.</p>
            </div>

            <h3>1. Rule Prioritization</h3>
            <p>Organize rules with proper priorities:</p>
            <ul>
                <li><strong>100-199:</strong> High-priority security rules (blocking)</li>
                <li><strong>200-299:</strong> Network connectivity rules</li>
                <li><strong>300-399:</strong> Application rules</li>
                <li><strong>400-499:</strong> Management and monitoring rules</li>
            </ul>

            <h3>2. Logging and Monitoring</h3>
            <p>Enable diagnostic logging for security analysis:</p>

            <div class="code-block">
                <pre><code class="language-hcl"># Log Analytics Workspace
resource "azurerm_log_analytics_workspace" "firewall" {
  name                = "law-firewall-${var.environment}"
  location            = azurerm_resource_group.firewall.location
  resource_group_name = azurerm_resource_group.firewall.name
  sku                 = "PerGB2018"
  retention_in_days   = 90
}

# Diagnostic Settings
resource "azurerm_monitor_diagnostic_setting" "firewall" {
  name                       = "firewall-diagnostics"
  target_resource_id         = azurerm_firewall.main.id
  log_analytics_workspace_id = azurerm_log_analytics_workspace.firewall.id

  enabled_log {
    category = "AzureFirewallApplicationRule"
  }

  enabled_log {
    category = "AzureFirewallNetworkRule"
  }

  enabled_log {
    category = "AzureFirewallDnsProxy"
  }

  metric {
    category = "AllMetrics"
    enabled  = true
  }
}</code></pre>
            </div>

            <h2>Cost Optimization Strategies</h2>
            <p>Azure Firewall can be expensive, especially in non-production environments. Consider these cost optimization strategies:</p>

            <h3>1. Scheduled Firewall Shutdown</h3>
            <p>For development environments, implement automated shutdown:</p>

            <div class="code-block">
                <pre><code class="language-hcl"># Automation Account for scheduling
resource "azurerm_automation_account" "firewall" {
  count               = var.environment == "dev" ? 1 : 0
  name                = "aa-firewall-${var.environment}"
  location            = azurerm_resource_group.firewall.location
  resource_group_name = azurerm_resource_group.firewall.name
  sku_name            = "Basic"
}

# Runbook for firewall management
resource "azurerm_automation_runbook" "firewall_shutdown" {
  count                   = var.environment == "dev" ? 1 : 0
  name                    = "Stop-AzureFirewall"
  location                = azurerm_resource_group.firewall.location
  resource_group_name     = azurerm_resource_group.firewall.name
  automation_account_name = azurerm_automation_account.firewall[0].name
  log_verbose             = true
  log_progress            = true
  runbook_type            = "PowerShell"

  content = file("${path.module}/scripts/stop-firewall.ps1")
}</code></pre>
            </div>

            <h2>Testing and Validation</h2>
            <p>Implement proper testing for your firewall configurations:</p>

            <h3>1. Terraform Validation</h3>
            <div class="code-block">
                <pre><code class="language-bash"># Validate Terraform configuration
terraform validate

# Plan with specific variable file
terraform plan -var-file="environments/prod.tfvars"

# Format code
terraform fmt -recursive</code></pre>
            </div>

            <h3>2. Policy Validation</h3>
            <p>Use Azure Policy to enforce firewall configuration standards:</p>

            <div class="code-block">
                <pre><code class="language-json">{
  "if": {
    "allOf": [
      {
        "field": "type",
        "equals": "Microsoft.Network/azureFirewalls"
      },
      {
        "field": "Microsoft.Network/azureFirewalls/threatIntelMode",
        "notEquals": "Deny"
      }
    ]
  },
  "then": {
    "effect": "deny"
  }
}</code></pre>
            </div>

            <h2>Conclusion</h2>
            <p>Managing Azure Firewall with Terraform provides consistency, repeatability, and version control for your network security infrastructure. By following these best practices, you can:</p>

            <ul>
                <li>Maintain consistent firewall configurations across environments</li>
                <li>Implement proper rule organization and prioritization</li>
                <li>Enable comprehensive logging and monitoring</li>
                <li>Optimize costs through automation</li>
                <li>Ensure security compliance through policy enforcement</li>
            </ul>

            <p>Remember to regularly review and update your firewall rules, monitor logs for security events, and stay current with Azure Firewall feature updates to maintain an effective security posture.</p>

            <div class="article-nav">
                <a href="/blogs" class="nav-link">
                    <i class="fas fa-arrow-left"></i>
                    All Articles
                </a>
                <a href="azure-waf-configuration-guide.html" class="nav-link">
                    Next Article
                    <i class="fas fa-arrow-right"></i>
                </a>
            </div>
        </article>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
</body>
</html>
